{"version":3,"file":"cli.js","sources":["../src/ensureDeps.ts","../src/pipeline.ts","../src/prefixStream.ts","../src/zipDist.ts","../src/cli.ts"],"sourcesContent":["import { resolve } from \"path\";\r\nimport { existsSync, readFileSync } from \"fs\";\r\nimport { spawnSync } from \"child_process\";\r\nimport type { ExtenzoResolvedConfig } from \"@extenzo/core\";\r\n\r\n/** 扩展开发推荐/必选 devDependencies：未安装时由框架自动安装（业界常见：按需补齐） */\r\nconst EXTENSION_DEV_DEPS = [\"@types/chrome\"] as const;\r\n\r\n/** 框架插件名 → 用户项目需安装的运行时依赖（peer 概念，未装则自动安装） */\r\nconst PLUGIN_PEER_DEPS: Record<string, readonly string[]> = {\r\n  \"extenzo-vue\": [\"vue\"],\r\n  \"extenzo-react\": [\"react\", \"react-dom\"],\r\n};\r\n\r\ntype PackageManager = \"pnpm\" | \"npm\" | \"yarn\" | \"bun\";\r\n\r\nfunction detectPackageManager(root: string): PackageManager {\r\n  if (existsSync(resolve(root, \"pnpm-lock.yaml\"))) return \"pnpm\";\r\n  if (existsSync(resolve(root, \"bun.lockb\"))) return \"bun\";\r\n  if (existsSync(resolve(root, \"yarn.lock\"))) return \"yarn\";\r\n  if (existsSync(resolve(root, \"package-lock.json\"))) return \"npm\";\r\n  return \"pnpm\";\r\n}\r\n\r\nfunction readProjectPackageJson(root: string): { dependencies?: Record<string, string>; devDependencies?: Record<string, string> } | null {\r\n  const p = resolve(root, \"package.json\");\r\n  if (!existsSync(p)) return null;\r\n  try {\r\n    const raw = readFileSync(p, \"utf-8\");\r\n    return JSON.parse(raw) as { dependencies?: Record<string, string>; devDependencies?: Record<string, string> };\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction isPackageInManifest(root: string, name: string): boolean {\r\n  const pkg = readProjectPackageJson(root);\r\n  if (!pkg) return false;\r\n  const deps = { ...pkg.dependencies, ...pkg.devDependencies };\r\n  return typeof deps === \"object\" && Object.prototype.hasOwnProperty.call(deps, name);\r\n}\r\n\r\nfunction getPluginNamesFromConfig(config: ExtenzoResolvedConfig): string[] {\r\n  const plugins = config.plugins;\r\n  if (!plugins) return [];\r\n  const list = Array.isArray(plugins) ? plugins : [plugins];\r\n  const names: string[] = [];\r\n  for (const p of list) {\r\n    if (p && typeof p === \"object\" && \"name\" in p && typeof (p as { name?: string }).name === \"string\")\r\n      names.push((p as { name: string }).name);\r\n  }\r\n  return names;\r\n}\r\n\r\nfunction collectPackagesToInstall(root: string, config: ExtenzoResolvedConfig): string[] {\r\n  const toInstall: string[] = [];\r\n  for (const name of EXTENSION_DEV_DEPS) {\r\n    if (!isPackageInManifest(root, name)) toInstall.push(name);\r\n  }\r\n  const pluginNames = getPluginNamesFromConfig(config);\r\n  for (const [pluginName, peers] of Object.entries(PLUGIN_PEER_DEPS)) {\r\n    if (!pluginNames.includes(pluginName)) continue;\r\n    for (const pkg of peers) {\r\n      if (!isPackageInManifest(root, pkg)) toInstall.push(pkg);\r\n    }\r\n  }\r\n  return [...new Set(toInstall)];\r\n}\r\n\r\nfunction runInstall(root: string, pm: PackageManager, packages: string[], dev: boolean): boolean {\r\n  let cmd: string;\r\n  let args: string[];\r\n  if (pm === \"npm\") {\r\n    cmd = \"npm\";\r\n    args = dev ? [\"install\", \"-D\", ...packages] : [\"install\", ...packages];\r\n  } else if (pm === \"bun\") {\r\n    cmd = \"bun\";\r\n    args = dev ? [\"add\", \"-d\", ...packages] : [\"add\", ...packages];\r\n  } else {\r\n    cmd = pm;\r\n    args = dev ? [\"add\", \"-D\", ...packages] : [\"add\", ...packages];\r\n  }\r\n  const result = spawnSync(cmd, args, {\r\n    cwd: root,\r\n    stdio: \"inherit\",\r\n    shell: true,\r\n  });\r\n  return result.status === 0;\r\n}\r\n\r\n/**\r\n * 按业界常见方式：检查项目是否已安装扩展开发与插件所需的依赖，缺失则用当前包管理器自动安装。\r\n * 可通过环境变量 EXTENZO_SKIP_DEPS=1 跳过（如 CI 或用户已统一管理依赖）。\r\n */\r\nexport async function ensureDependencies(\r\n  root: string,\r\n  config: ExtenzoResolvedConfig,\r\n  options?: { silent?: boolean }\r\n): Promise<{ installed: string[] }> {\r\n  if (process.env.EXTENZO_SKIP_DEPS === \"1\") return { installed: [] };\r\n\r\n  const toInstall = collectPackagesToInstall(root, config);\r\n  if (toInstall.length === 0) return { installed: [] };\r\n\r\n  if (!options?.silent) {\r\n    console.log(`[extenzo] Ensuring dev dependencies: ${toInstall.join(\", \")}`);\r\n  }\r\n  const pm = detectPackageManager(root);\r\n  const ok = runInstall(root, pm, toInstall, true);\r\n  if (!ok && !options?.silent) {\r\n    console.warn(`[extenzo] Failed to install some dependencies. You may run: ${pm} add -D ${toInstall.join(\" \")}`);\r\n  }\r\n  return { installed: ok ? toInstall : [] };\r\n}\r\n","import { resolve } from \"path\";\nimport type { RsbuildConfig } from \"@rsbuild/core\";\nimport {\n  CliParser,\n  ConfigLoader,\n  mergeRsbuildConfig,\n  HMR_WS_PORT,\n} from \"@extenzo/core\";\nimport type { PipelineContext } from \"@extenzo/core\";\nimport { entryPlugin } from \"@extenzo/plugin-entry\";\nimport { extensionPlugin } from \"@extenzo/plugin-extension\";\nimport { hmrPlugin } from \"@extenzo/plugin-hmr\";\nimport { getVueRsbuildPlugins } from \"@extenzo/plugin-vue\";\nimport { getReactRsbuildPlugins } from \"@extenzo/plugin-react\";\nimport { ensureDependencies } from \"./ensureDeps.js\";\n\ntype LoosePlugin = RsbuildConfig[\"plugins\"] extends (infer P)[] ? P : never;\n\nfunction isHmrPlugin(p: unknown): boolean {\n  if (!p || typeof p !== \"object\") return false;\n  const obj = p as { constructor?: { name?: string }; name?: string };\n  const byConstructor = obj.constructor?.name === \"HotModuleReplacementPlugin\";\n  const byName = obj.name === \"HotModuleReplacementPlugin\";\n  return Boolean(byConstructor || byName);\n}\n\n/**\n * 禁用 Rspack 的 HMR，避免 dist 下生成 *.hot-update.js / *.hot-update.json 并触发循环构建。\n *\n * 根因简述：我们用的是「Rsbuild 的 build watch」（extenzo dev → rsbuild.build({ watch: true })），\n * 不启 dev server。Rspack 在 watch 模式下仍可能被注入 HotModuleReplacementPlugin（或受 dev 配置影响），\n * 每次增量构建会往输出目录写 hot-update 文件；若 watch 未正确忽略该目录，会再次触发构建，形成循环并堆积大量无用 js。\n * 引入 PostCSS 配置（如 @tailwindcss/postcss）会扩大 CSS 依赖与增量构建频率，使该问题更易复现。\n * 因此在此处强制关闭 devServer.hot 并移除 HMR 插件。\n */\nfunction disableRspackHmr(rspackConfig: unknown): void {\n  const c = rspackConfig as {\n    devServer?: { hot?: boolean };\n    plugins?: unknown[];\n  };\n  if (c.devServer) c.devServer.hot = false;\n  else (c as Record<string, unknown>).devServer = { hot: false };\n  if (Array.isArray(c.plugins))\n    c.plugins = c.plugins.filter((p: unknown) => !isHmrPlugin(p));\n}\n\n/**\n * 构建流水线：串联 CLI 解析 → 配置加载 → Rsbuild 配置生成 → 钩子执行。\n */\nexport class Pipeline {\n  constructor(\n    private readonly configLoader: ConfigLoader = new ConfigLoader(),\n    private readonly cliParser: CliParser = new CliParser()\n  ) {}\n\n  async run(root: string, argv: string[]): Promise<PipelineContext> {\n    const parseResult = this.cliParser.parse(argv);\n    if (parseResult.unknownBrowser) {\n      console.warn(\n        `Unknown browser \"${parseResult.unknownBrowser}\", use chrome or firefox. Defaulting to chromium.`\n      );\n    }\n    process.env.BROWSER = parseResult.browser;\n\n    const { config, baseEntries, entries } = this.configLoader.resolve(root);\n    await ensureDependencies(root, config);\n    const outDir = config.outDir;\n    const outputRoot = config.outputRoot;\n    const distPath = resolve(root, outputRoot, outDir);\n    const isDev = parseResult.command === \"dev\";\n\n    let baseConfig = this.buildBaseRsbuildConfig({ root, config, baseEntries, entries });\n    baseConfig = await this.applyUserRsbuildConfig(baseConfig, config);\n    baseConfig = this.injectHmrForDev(baseConfig, {\n      root,\n      command: parseResult.command,\n      browser: parseResult.browser,\n      config,\n      baseEntries,\n      entries,\n      rsbuildConfig: baseConfig,\n      isDev,\n      distPath,\n    });\n\n    const ctx: PipelineContext = {\n      root,\n      command: parseResult.command,\n      browser: parseResult.browser,\n      config,\n      baseEntries,\n      entries,\n      rsbuildConfig: baseConfig,\n      isDev,\n      distPath,\n    };\n\n    await config.hooks?.afterCliParsed?.(ctx);\n    await config.hooks?.afterConfigLoaded?.(ctx);\n    await config.hooks?.beforeRsbuildConfig?.(ctx);\n    await config.hooks?.beforeBuild?.(ctx);\n\n    return ctx;\n  }\n\n  private expandFrameworkPlugins(\n    userPlugins: RsbuildConfig[\"plugins\"] | undefined,\n    appRoot: string\n  ): LoosePlugin[] {\n    const out: LoosePlugin[] = [];\n    const list = userPlugins ?? [];\n    const arr = Array.isArray(list) ? list : [list];\n    for (const p of arr) {\n      const name = (p as { name?: string } | null)?.name;\n      if (name === \"extenzo-vue\") {\n        const vuePlugins = getVueRsbuildPlugins(appRoot);\n        if (Array.isArray(vuePlugins)) out.push(...(vuePlugins as LoosePlugin[]));\n      }\n      if (name === \"extenzo-react\") {\n        const reactPlugins = getReactRsbuildPlugins(appRoot);\n        if (Array.isArray(reactPlugins)) out.push(...(reactPlugins as LoosePlugin[]));\n      }\n      out.push(p as LoosePlugin);\n    }\n    return out;\n  }\n\n  private buildBaseRsbuildConfig(\n    ctx: Pick<PipelineContext, \"root\" | \"config\" | \"baseEntries\" | \"entries\">\n  ): RsbuildConfig {\n    const expanded = this.expandFrameworkPlugins(ctx.config.plugins, ctx.root);\n    const plugins: RsbuildConfig[\"plugins\"] = [\n      entryPlugin(ctx.config, ctx.entries),\n      ...expanded,\n      extensionPlugin(ctx.config, ctx.entries),\n    ];\n    return { root: ctx.root, plugins };\n  }\n\n  private async applyUserRsbuildConfig(\n    base: RsbuildConfig,\n    config: PipelineContext[\"config\"]\n  ): Promise<RsbuildConfig> {\n    const user = config.rsbuildConfig ?? config.rsbuild;\n    if (typeof user === \"function\") return user(base);\n    if (user && typeof user === \"object\") return mergeRsbuildConfig(base, user);\n    return base;\n  }\n\n  private injectHmrForDev(\n    baseConfig: RsbuildConfig,\n    ctx: PipelineContext\n  ): RsbuildConfig {\n    if (!ctx.isDev) return baseConfig;\n    const prevRspack = baseConfig.tools?.rspack;\n    const hmrOpts = {\n      distPath: ctx.distPath,\n      autoOpen: true,\n      browser: ctx.browser,\n      chromePath: ctx.config.launch?.chrome,\n      firefoxPath: ctx.config.launch?.firefox,\n      wsPort: HMR_WS_PORT,\n      enableReload: true,\n    };\n    return {\n      ...baseConfig,\n      dev: {\n        ...baseConfig.dev,\n        hmr: false,\n        liveReload: false,\n      },\n      tools: {\n        ...baseConfig.tools,\n        rspack: ((rspackConfig: unknown, utils: { appendPlugins?: (p: unknown) => void }) => {\n          let result = rspackConfig;\n          if (typeof prevRspack === \"function\") {\n            result =\n              (prevRspack as (c: unknown, e: unknown) => unknown)(rspackConfig, utils) ??\n              rspackConfig;\n          }\n          disableRspackHmr(result);\n          if (utils?.appendPlugins) utils.appendPlugins(hmrPlugin(hmrOpts));\n          return result;\n        }) as RsbuildConfig[\"tools\"] extends { rspack?: infer R } ? R : never,\n      },\n    };\n  }\n}\n\nconst defaultPipeline = new Pipeline();\n\nexport function runPipeline(root: string, argv: string[]): Promise<PipelineContext> {\n  return defaultPipeline.run(root, argv);\n}\n","/** ANSI: cyan, then reset */\r\nconst PREFIX = \"\\x1b[36m[extenzo]\\x1b[0m \";\r\n\r\ntype Encoding = BufferEncoding | ((err?: Error) => void);\r\ntype WriteCallback = (err?: Error) => void;\r\n\r\nfunction isEncoding(x: Encoding | undefined): x is BufferEncoding {\r\n  return typeof x === \"string\";\r\n}\r\n\r\nfunction createPrefixedWrite(\r\n  stream: NodeJS.WriteStream,\r\n  getPrefix: () => string\r\n): NodeJS.WriteStream[\"write\"] {\r\n  const originalWrite = stream.write.bind(stream);\r\n  let buffer = \"\";\r\n\r\n  function flushIncomplete() {\r\n    if (buffer.length > 0) {\r\n      originalWrite(getPrefix() + buffer);\r\n      buffer = \"\";\r\n    }\r\n  }\r\n\r\n  const write: NodeJS.WriteStream[\"write\"] = function (\r\n    chunk: string | Buffer | Uint8Array,\r\n    encodingOrCallback?: Encoding,\r\n    callback?: WriteCallback\r\n  ): boolean {\r\n    const encoding: BufferEncoding | undefined = isEncoding(encodingOrCallback)\r\n      ? encodingOrCallback\r\n      : undefined;\r\n    const cb = typeof encodingOrCallback === \"function\" ? encodingOrCallback : callback;\r\n    const str = typeof chunk === \"string\" ? chunk : chunk.toString(encoding ?? \"utf8\");\r\n    buffer += str;\r\n    const lines = buffer.split(\"\\n\");\r\n    buffer = lines.pop() ?? \"\";\r\n    for (const line of lines) {\r\n      originalWrite(getPrefix() + line + \"\\n\", encoding as BufferEncoding);\r\n    }\r\n    if (typeof cb === \"function\") cb();\r\n    return true;\r\n  };\r\n\r\n  (write as { flush?: () => void }).flush = flushIncomplete;\r\n  return write;\r\n}\r\n\r\n/**\r\n * Wraps process.stdout and process.stderr so each line is prefixed with colored \"[extenzo]\".\r\n * Call before running rsbuild dev/build so users see that extenzo is executing.\r\n * Original rsbuild output is preserved line-by-line.\r\n */\r\nexport function wrapExtenzoOutput(): void {\r\n  const prefix = () => PREFIX;\r\n  const stdoutWrite = createPrefixedWrite(process.stdout, prefix);\r\n  const stderrWrite = createPrefixedWrite(process.stderr, prefix);\r\n\r\n  (process.stdout as NodeJS.WriteStream & { write: NodeJS.WriteStream[\"write\"] }).write = stdoutWrite;\r\n  (process.stderr as NodeJS.WriteStream & { write: NodeJS.WriteStream[\"write\"] }).write = stderrWrite;\r\n\r\n  const flush = () => {\r\n    const fOut = (stdoutWrite as { flush?: () => void }).flush;\r\n    const fErr = (stderrWrite as { flush?: () => void }).flush;\r\n    if (fOut) fOut();\r\n    if (fErr) fErr();\r\n  };\r\n\r\n  process.once(\"exit\", flush);\r\n}\r\n","import { createWriteStream } from \"fs\";\nimport { resolve } from \"path\";\nimport archiver from \"archiver\";\nimport type { ExtenzoErrorCode } from \"@extenzo/core\";\nimport { ExtenzoError } from \"@extenzo/core\";\n\n/** Error codes for zip operations; match core EXTENZO_ERROR_CODES */\nconst ZIP_OUTPUT_CODE = \"EXTENZO_ZIP_OUTPUT\" as ExtenzoErrorCode;\nconst ZIP_ARCHIVE_CODE = \"EXTENZO_ZIP_ARCHIVE\" as ExtenzoErrorCode;\n\n/** Default zlib level for zip compression */\nconst ZIP_LEVEL = 9;\n\n/**\n * Packs the built output directory into a zip file at project root.\n * Zip contents are the files inside distPath (no extra top-level folder).\n */\nexport function zipDist(\n  distPath: string,\n  root: string,\n  outDir: string\n): Promise<string> {\n  const zipPath = resolve(root, `${outDir}.zip`);\n  const output = createWriteStream(zipPath);\n  const archive = archiver(\"zip\", { zlib: { level: ZIP_LEVEL } });\n\n  return new Promise((resolvePromise, reject) => {\n    output.on(\"error\", (err) =>\n      reject(\n        new ExtenzoError(\"Zip output stream failed\", {\n          code: ZIP_OUTPUT_CODE,\n          details: err instanceof Error ? err.message : String(err),\n          cause: err,\n        })\n      )\n    );\n    output.on(\"close\", () => resolvePromise(zipPath));\n\n    archive.on(\"error\", (err: unknown) =>\n      reject(\n        new ExtenzoError(\"Zip archive failed\", {\n          code: ZIP_ARCHIVE_CODE,\n          details: err instanceof Error ? err.message : String(err),\n          cause: err,\n        })\n      )\n    );\n    archive.pipe(output);\n    archive.directory(distPath, false);\n    archive.finalize();\n  });\n}\n","#!/usr/bin/env node\nimport { resolve } from \"path\";\nimport { existsSync } from \"fs\";\nimport { runPipeline } from \"./pipeline.js\";\nimport { wrapExtenzoOutput } from \"./prefixStream.js\";\nimport { zipDist } from \"./zipDist.js\";\nimport { exitWithError, createConfigNotFoundError, CONFIG_FILES } from \"@extenzo/core\";\n\nconst root = process.cwd();\n\nfunction hasConfigFile(): boolean {\n  return CONFIG_FILES.some((file) => existsSync(resolve(root, file)));\n}\n\nasync function main(): Promise<void> {\n  if (!hasConfigFile()) throw createConfigNotFoundError(root);\n\n  const argv = process.argv.slice(2);\n  const ctx = await runPipeline(root, argv);\n\n  process.env.NODE_ENV = ctx.isDev ? \"development\" : \"production\";\n  wrapExtenzoOutput();\n\n  const { createRsbuild } = await import(\"@rsbuild/core\");\n  const rsbuild = await createRsbuild({ rsbuildConfig: ctx.rsbuildConfig });\n\n  if (ctx.command === \"dev\") {\n    await rsbuild.build({ watch: true });\n  } else {\n    await rsbuild.build();\n    await ctx.config.hooks?.afterBuild?.(ctx);\n    if (ctx.config.zip !== false) {\n      const zipPath = await zipDist(ctx.distPath, ctx.root, ctx.config.outDir);\n      console.log(`Zipped output to ${zipPath}`);\n    }\n  }\n}\n\nmain().catch((e) => exitWithError(e));\n"],"names":["EXTENSION_DEV_DEPS","PLUGIN_PEER_DEPS","detectPackageManager","root","existsSync","resolve","readProjectPackageJson","p","raw","readFileSync","JSON","isPackageInManifest","name","pkg","deps","Object","getPluginNamesFromConfig","config","plugins","list","Array","names","collectPackagesToInstall","toInstall","pluginNames","pluginName","peers","Set","runInstall","pm","packages","dev","cmd","args","result","spawnSync","ensureDependencies","options","process","console","ok","isHmrPlugin","obj","byConstructor","byName","Boolean","disableRspackHmr","rspackConfig","c","Pipeline","configLoader","ConfigLoader","cliParser","CliParser","argv","parseResult","baseEntries","entries","outDir","outputRoot","distPath","isDev","baseConfig","ctx","userPlugins","appRoot","out","arr","vuePlugins","getVueRsbuildPlugins","reactPlugins","getReactRsbuildPlugins","expanded","entryPlugin","extensionPlugin","base","user","mergeRsbuildConfig","prevRspack","hmrOpts","HMR_WS_PORT","utils","hmrPlugin","defaultPipeline","runPipeline","PREFIX","isEncoding","x","createPrefixedWrite","stream","getPrefix","originalWrite","buffer","flushIncomplete","write","chunk","encodingOrCallback","callback","encoding","undefined","cb","str","lines","line","wrapExtenzoOutput","prefix","stdoutWrite","stderrWrite","flush","fOut","fErr","ZIP_OUTPUT_CODE","ZIP_ARCHIVE_CODE","ZIP_LEVEL","zipDist","zipPath","output","createWriteStream","archive","archiver","Promise","resolvePromise","reject","err","ExtenzoError","Error","String","hasConfigFile","CONFIG_FILES","file","main","createConfigNotFoundError","createRsbuild","rsbuild","e","exitWithError"],"mappings":"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"}