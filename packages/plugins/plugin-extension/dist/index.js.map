{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import type { Compiler } from \"@rspack/core\";\nimport type { RsbuildPluginAPI } from \"@rsbuild/core\";\nimport { resolve } from \"path\";\nimport { writeFileSync, existsSync, mkdirSync, unlinkSync } from \"fs\";\nimport type { ExtenzoResolvedConfig } from \"@extenzo/core\";\nimport type { EntryInfo } from \"@extenzo/core\";\nimport { resolveManifestChromium, resolveManifestFirefox } from \"@extenzo/core\";\n\nconst NO_HTML_ENTRIES = [\"background\", \"content\"];\n\n/**\n * Only generates manifest.json after build and removes stray HTML for background/content.\n * Entry and HTML are handled by plugin-entry.\n */\nexport function extensionPlugin(\n  resolvedConfig: ExtenzoResolvedConfig,\n  entries: EntryInfo[]\n) {\n  const { root, outDir, outputRoot, manifest } = resolvedConfig;\n  const distPath = resolve(root, outputRoot, outDir);\n\n  return {\n    name: \"extenzo-extension\",\n    setup(api: RsbuildPluginAPI) {\n      api.onBeforeCreateCompiler(async ({ bundlerConfigs }) => {\n        const config = bundlerConfigs[0];\n        if (!config) return;\n        config.plugins = config.plugins ?? [];\n        config.plugins.push({\n          name: \"extenzo-extension-post-build\",\n          apply(compiler: Compiler) {\n            compiler.hooks.afterEmit.tap(\"extenzo-extension-post-build\", () => {\n              if (!existsSync(distPath)) mkdirSync(distPath, { recursive: true });\n              for (const name of NO_HTML_ENTRIES) {\n                const nestedPath = resolve(distPath, name, \"index.html\");\n                const flatPath = resolve(distPath, `${name}.html`);\n                for (const htmlPath of [nestedPath, flatPath]) {\n                  if (existsSync(htmlPath)) {\n                    try {\n                      unlinkSync(htmlPath);\n                    } catch {\n                      // ignore\n                    }\n                  }\n                }\n              }\n              const browser = (process.env.BROWSER as \"chromium\" | \"firefox\") || \"chromium\";\n              const manifestObj =\n                browser === \"firefox\"\n                  ? resolveManifestFirefox(manifest, entries)\n                  : resolveManifestChromium(manifest, entries);\n              writeFileSync(\n                resolve(distPath, \"manifest.json\"),\n                JSON.stringify(manifestObj, null, 2),\n                \"utf-8\"\n              );\n            });\n          },\n        });\n      });\n    },\n  };\n}\n"],"names":["NO_HTML_ENTRIES","extensionPlugin","resolvedConfig","entries","root","outDir","outputRoot","manifest","distPath","resolve","api","bundlerConfigs","config","compiler","existsSync","mkdirSync","name","nestedPath","flatPath","htmlPath","unlinkSync","browser","process","manifestObj","resolveManifestFirefox","resolveManifestChromium","writeFileSync","JSON"],"mappings":";;;AAQA,MAAMA,kBAAkB;IAAC;IAAc;CAAU;AAM1C,SAASC,gBACdC,cAAqC,EACrCC,OAAoB;IAEpB,MAAM,EAAEC,IAAI,EAAEC,MAAM,EAAEC,UAAU,EAAEC,QAAQ,EAAE,GAAGL;IAC/C,MAAMM,WAAWC,QAAQL,MAAME,YAAYD;IAE3C,OAAO;QACL,MAAM;QACN,OAAMK,GAAqB;YACzBA,IAAI,sBAAsB,CAAC,OAAO,EAAEC,cAAc,EAAE;gBAClD,MAAMC,SAASD,cAAc,CAAC,EAAE;gBAChC,IAAI,CAACC,QAAQ;gBACbA,OAAO,OAAO,GAAGA,OAAO,OAAO,IAAI,EAAE;gBACrCA,OAAO,OAAO,CAAC,IAAI,CAAC;oBAClB,MAAM;oBACN,OAAMC,QAAkB;wBACtBA,SAAS,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,gCAAgC;4BAC3D,IAAI,CAACC,WAAWN,WAAWO,UAAUP,UAAU;gCAAE,WAAW;4BAAK;4BACjE,KAAK,MAAMQ,QAAQhB,gBAAiB;gCAClC,MAAMiB,aAAaR,QAAQD,UAAUQ,MAAM;gCAC3C,MAAME,WAAWT,QAAQD,UAAU,GAAGQ,KAAK,KAAK,CAAC;gCACjD,KAAK,MAAMG,YAAY;oCAACF;oCAAYC;iCAAS,CAC3C,IAAIJ,WAAWK,WACb,IAAI;oCACFC,WAAWD;gCACb,EAAE,OAAM,CAER;4BAGN;4BACA,MAAME,UAAWC,QAAQ,GAAG,CAAC,OAAO,IAA+B;4BACnE,MAAMC,cACJF,AAAY,cAAZA,UACIG,uBAAuBjB,UAAUJ,WACjCsB,wBAAwBlB,UAAUJ;4BACxCuB,cACEjB,QAAQD,UAAU,kBAClBmB,KAAK,SAAS,CAACJ,aAAa,MAAM,IAClC;wBAEJ;oBACF;gBACF;YACF;QACF;IACF;AACF"}