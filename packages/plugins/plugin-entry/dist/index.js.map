{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { resolve, basename } from \"path\";\r\nimport { readFileSync, existsSync } from \"fs\";\r\nimport type { RsbuildPluginAPI } from \"@rsbuild/core\";\r\nimport type { ExtenzoResolvedConfig } from \"@extenzo/core\";\r\nimport type { EntryInfo } from \"@extenzo/core\";\r\n\r\nconst NO_HTML_ENTRIES = [\"background\", \"content\"];\r\n\r\nfunction isHmrPlugin(p: unknown): boolean {\r\n  if (!p || typeof p !== \"object\") return false;\r\n  const obj = p as { constructor?: { name?: string }; name?: string };\r\n  return (\r\n    obj.constructor?.name === \"HotModuleReplacementPlugin\" ||\r\n    obj.name === \"HotModuleReplacementPlugin\"\r\n  );\r\n}\r\n\r\n/** Disable Rspack HMR so dist is not filled with *.hot-update.js (extension build watch). */\r\nfunction disableRspackHmrInPlace(config: Record<string, unknown>): void {\r\n  const devServer = config.devServer as Record<string, unknown> | undefined;\r\n  if (devServer) devServer.hot = false;\r\n  else config.devServer = { hot: false };\r\n  const plugins = config.plugins;\r\n  if (Array.isArray(plugins))\r\n    config.plugins = plugins.filter((p: unknown) => !isHmrPlugin(p));\r\n}\r\n\r\nfunction buildTemplateMapFromEntries(entries: EntryInfo[]): Record<string, string> {\r\n  const map: Record<string, string> = {};\r\n  for (const e of entries) {\r\n    if (e.htmlPath) map[e.name] = e.htmlPath;\r\n  }\r\n  return map;\r\n}\r\n\r\nfunction buildFilenameMap(entries: EntryInfo[]): Record<string, string> {\r\n  const map: Record<string, string> = {\r\n    popup: \"popup/index.html\",\r\n    options: \"options/index.html\",\r\n    sidepanel: \"sidepanel/index.html\",\r\n    devtools: \"devtools/index.html\",\r\n  };\r\n  for (const e of entries) {\r\n    if (e.htmlPath && !map[e.name])\r\n      map[e.name] = `${e.name}/${basename(e.htmlPath)}`;\r\n  }\r\n  return map;\r\n}\r\n\r\n/** Remove local script tags only; keep scripts with src starting with http:// or https:// (e.g. CDN). */\r\nfunction stripScriptsInTemplate(templatePath: string): string {\r\n  if (!existsSync(templatePath)) return \"\";\r\n  let content = readFileSync(templatePath, \"utf-8\");\r\n  content = content.replace(\r\n    /<script[^>]*src=\"([^\"]*)\"[^>]*><\\/script>/gi,\r\n    (fullMatch, src) => (/^https?:\\/\\//i.test(src.trim()) ? fullMatch : \"\")\r\n  );\r\n  return content;\r\n}\r\n\r\nexport function entryPlugin(resolvedConfig: ExtenzoResolvedConfig, entries: EntryInfo[]) {\r\n  const { outDir, outputRoot, root } = resolvedConfig;\r\n  const publicDir = resolve(root, \"public\");\r\n\r\n  const entry: Record<string, string> = {};\r\n  for (const e of entries) entry[e.name] = e.scriptPath;\r\n  const entryNames = new Set(Object.keys(entry));\r\n\r\n  const templateMap = buildTemplateMapFromEntries(entries);\r\n  const filenameMap = buildFilenameMap(entries);\r\n\r\n  return {\r\n    name: \"extenzo-entry\",\r\n    setup(api: RsbuildPluginAPI) {\r\n      api.modifyRsbuildConfig((config) => {\r\n        config.source = config.source ?? {};\r\n        config.source.entry = { ...(config.source.entry as Record<string, string>), ...entry };\r\n\r\n        config.html = config.html ?? {};\r\n        const prevTemplate = config.html.template;\r\n        config.html.template = (opts: { value: string; entryName: string }): string | void => {\r\n          if (templateMap[opts.entryName]) return templateMap[opts.entryName];\r\n          if (typeof prevTemplate === \"function\") return prevTemplate(opts);\r\n          return undefined;\r\n        };\r\n        config.html.outputStructure = config.html.outputStructure ?? \"nested\";\r\n\r\n        config.tools = config.tools ?? {};\r\n        const prevHtmlPlugin = config.tools.htmlPlugin;\r\n        config.tools.htmlPlugin = (\r\n          htmlConfig: Record<string, unknown>,\r\n          ctx: { entryName: string; entryValue: unknown }\r\n        ) => {\r\n          if (prevHtmlPlugin && typeof prevHtmlPlugin === \"function\")\r\n            prevHtmlPlugin(htmlConfig, ctx as Parameters<NonNullable<typeof prevHtmlPlugin>>[1]);\r\n          if (filenameMap[ctx.entryName])\r\n            (htmlConfig as Record<string, string>).filename = filenameMap[ctx.entryName];\r\n          const templatePath = (htmlConfig as { template?: string }).template;\r\n          if (\r\n            typeof templatePath === \"string\" &&\r\n            existsSync(templatePath) &&\r\n            entries.some((e) => e.htmlPath === templatePath)\r\n          ) {\r\n            const content = stripScriptsInTemplate(templatePath);\r\n            (htmlConfig as Record<string, string>).templateContent = content;\r\n            (htmlConfig as Record<string, unknown>).template = content;\r\n          }\r\n        };\r\n\r\n        config.output = config.output ?? {};\r\n        const outputDir = `${outputRoot}/${outDir}`;\r\n        const existingDistPath =\r\n          config.output.distPath && typeof config.output.distPath === \"object\"\r\n            ? config.output.distPath\r\n            : {};\r\n        config.output.distPath = { ...existingDistPath, root: outputDir };\r\n        config.output.cleanDistPath = config.output.cleanDistPath ?? true;\r\n        config.output.assetPrefix = config.output.assetPrefix ?? \"/\";\r\n        if (existsSync(publicDir)) {\r\n          const copyRules = Array.isArray(config.output.copy) ? config.output.copy : [];\r\n          config.output.copy = [...copyRules, { from: publicDir }];\r\n        }\r\n      });\r\n\r\n      api.onBeforeCreateCompiler(async ({ bundlerConfigs }) => {\r\n        const c = bundlerConfigs[0];\r\n        if (!c) return;\r\n        disableRspackHmrInPlace(c as Record<string, unknown>);\r\n        const distPath = resolve(root, outputRoot, outDir);\r\n        const watchOpts = c.watchOptions ?? {};\r\n        const existingIgnored = watchOpts.ignored;\r\n        const ignoredList: (string | RegExp)[] = Array.isArray(existingIgnored)\r\n          ? [...existingIgnored, distPath]\r\n          : existingIgnored != null\r\n            ? [existingIgnored, distPath]\r\n            : [distPath];\r\n        c.watchOptions = { ...watchOpts, ignored: ignoredList as string[] };\r\n        if (c.output) {\r\n          c.output.path = distPath;\r\n          const jsChunkName = (pathData: { chunk?: { name?: string; id?: string } }) => {\r\n            const name = pathData.chunk?.name ?? pathData.chunk?.id ?? \"chunk\";\r\n            return entryNames.has(String(name)) ? `${name}/index.js` : `static/js/${name}.js`;\r\n          };\r\n          const cssChunkName = (pathData: { chunk?: { name?: string; id?: string } }) => {\r\n            const name = pathData.chunk?.name ?? pathData.chunk?.id ?? \"chunk\";\r\n            return entryNames.has(String(name)) ? `${name}/index.css` : `static/css/${name}.css`;\r\n          };\r\n          c.output.filename = jsChunkName as unknown as string;\r\n          c.output.chunkFilename = c.output.chunkFilename ?? jsChunkName;\r\n          c.output.cssFilename = cssChunkName as unknown as string;\r\n          c.output.cssChunkFilename = c.output.cssChunkFilename ?? cssChunkName;\r\n          c.output.publicPath = \"/\";\r\n        }\r\n        if (c.optimization) {\r\n          c.optimization.runtimeChunk = false;\r\n          c.optimization.splitChunks = c.optimization.splitChunks ?? {};\r\n          (c.optimization.splitChunks as Record<string, unknown>).chunks =\r\n            typeof (c.optimization.splitChunks as Record<string, unknown>).chunks === \"function\"\r\n              ? (c.optimization.splitChunks as Record<string, unknown>).chunks\r\n              : (chunk: { name?: string }) =>\r\n                  (chunk.name ? !NO_HTML_ENTRIES.includes(chunk.name) : true);\r\n        }\r\n      });\r\n    },\r\n  };\r\n}\r\n"],"names":["NO_HTML_ENTRIES","isHmrPlugin","p","obj","disableRspackHmrInPlace","config","devServer","plugins","Array","buildTemplateMapFromEntries","entries","map","e","buildFilenameMap","basename","stripScriptsInTemplate","templatePath","existsSync","content","readFileSync","fullMatch","src","entryPlugin","resolvedConfig","outDir","outputRoot","root","publicDir","resolve","entry","entryNames","Set","Object","templateMap","filenameMap","api","prevTemplate","opts","prevHtmlPlugin","htmlConfig","ctx","outputDir","existingDistPath","copyRules","bundlerConfigs","c","distPath","watchOpts","existingIgnored","ignoredList","jsChunkName","pathData","name","String","cssChunkName","chunk"],"mappings":"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"}