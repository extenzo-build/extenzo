{"version":3,"sources":["../src/index.ts","../src/defineConfig.ts","../src/config.ts","../src/discover.ts","../src/extraPages.ts","../src/manifest.ts","../src/mergeRsbuildConfig.ts"],"sourcesContent":["export { defineConfig } from \"./defineConfig.js\";\r\nexport { resolveExtenzoConfig } from \"./config.js\";\r\nexport { discoverEntries, getHtmlEntryNames, getScriptOnlyEntryNames } from \"./discover.js\";\r\nexport { getVideoRollExtraPages, resolveExtraPages } from \"./extraPages.js\";\r\nexport {\r\n  resolveManifestChromium,\r\n  resolveManifestFirefox,\r\n} from \"./manifest.js\";\r\nexport { mergeRsbuildConfig } from \"./mergeRsbuildConfig.js\";\r\nexport type {\r\n  ExtenzoUserConfig,\r\n  ExtenzoResolvedConfig,\r\n  ManifestConfig,\r\n  EntryInfo,\r\n  ExtraPageItem,\r\n} from \"./types.js\";\r\n","import type { ExtenzoUserConfig } from \"./types.js\";\r\n\r\nexport function defineConfig(config: ExtenzoUserConfig): ExtenzoUserConfig {\r\n  return config;\r\n}\r\n","import { createRequire } from \"module\";\r\nimport { resolve } from \"path\";\r\nimport { existsSync } from \"fs\";\r\nimport type { ExtenzoUserConfig, ExtenzoResolvedConfig } from \"./types.js\";\r\nimport { discoverEntries } from \"./discover.js\";\r\nimport type { EntryInfo } from \"./types.js\";\r\n\r\nconst require = createRequire(\r\n  typeof __filename !== \"undefined\" ? __filename : import.meta.url\r\n);\r\nconst CONFIG_FILES = [\"ext.config.ts\", \"ext.config.js\", \"ext.config.mjs\"];\r\n\r\nfunction loadConfigFile(root: string): ExtenzoUserConfig | null {\r\n  for (const file of CONFIG_FILES) {\r\n    const p = resolve(root, file);\r\n    if (!existsSync(p)) continue;\r\n    try {\r\n      const jiti = require(\"jiti\")(root, { esmResolve: true });\r\n      const mod = jiti(p);\r\n      return mod.default ?? mod;\r\n    } catch (e) {\r\n      console.warn(`Failed to load ${file}:`, e);\r\n      return null;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function resolveExtenzoConfig(root: string): {\r\n  config: ExtenzoResolvedConfig;\r\n  entries: EntryInfo[];\r\n} {\r\n  const user = loadConfigFile(root);\r\n  if (!user || !user.manifest) {\r\n    throw new Error(\"ext.config.ts/js not found or manifest is missing in config\");\r\n  }\r\n  const srcDir = resolve(root, user.srcDir ?? \".\");\r\n  const outDir = user.outDir ?? \"dist\";\r\n  const config: ExtenzoResolvedConfig = {\r\n    ...user,\r\n    srcDir,\r\n    outDir,\r\n    root,\r\n  };\r\n  const entries = discoverEntries(srcDir);\r\n  if (entries.length === 0) {\r\n    throw new Error(\r\n      `No entries found under ${srcDir} (expected at least one of: background, content, popup, options, sidepanel)`\r\n    );\r\n  }\r\n  return { config, entries };\r\n}\r\n","import { resolve } from \"path\";\r\nimport { existsSync, statSync } from \"fs\";\r\nimport type { EntryInfo } from \"./types.js\";\r\n\r\nconst SCRIPT_EXTS = [\".ts\", \".tsx\", \".js\", \".jsx\"];\r\nconst HTML_ENTRIES = [\"popup\", \"options\", \"sidepanel\"];\r\nconst SCRIPT_ONLY_ENTRIES = [\"background\", \"content\"];\r\n\r\nfunction findScriptInDir(dir: string): string | undefined {\r\n  for (const ext of SCRIPT_EXTS) {\r\n    const p = resolve(dir, `index${ext}`);\r\n    if (existsSync(p)) return p;\r\n  }\r\n  return undefined;\r\n}\r\n\r\nfunction hasIndexHtml(dir: string): boolean {\r\n  return existsSync(resolve(dir, \"index.html\"));\r\n}\r\n\r\n/**\r\n * Discover background, content, popup, options, sidepanel entries under baseDir\r\n */\r\nexport function discoverEntries(baseDir: string): EntryInfo[] {\r\n  const entries: EntryInfo[] = [];\r\n\r\n  for (const name of SCRIPT_ONLY_ENTRIES) {\r\n    const dir = resolve(baseDir, name);\r\n    if (!existsSync(dir) || !statSync(dir).isDirectory()) continue;\r\n    const scriptPath = findScriptInDir(dir);\r\n    if (scriptPath) entries.push({ name, scriptPath });\r\n  }\r\n\r\n  for (const name of HTML_ENTRIES) {\r\n    const dir = resolve(baseDir, name);\r\n    if (!existsSync(dir) || !statSync(dir).isDirectory()) continue;\r\n    const scriptPath = findScriptInDir(dir);\r\n    if (!scriptPath) continue;\r\n    const htmlPath = hasIndexHtml(dir) ? resolve(dir, \"index.html\") : undefined;\r\n    entries.push({ name, scriptPath, htmlPath });\r\n  }\r\n\r\n  return entries;\r\n}\r\n\r\nexport function getHtmlEntryNames(): string[] {\r\n  return HTML_ENTRIES;\r\n}\r\n\r\nexport function getScriptOnlyEntryNames(): string[] {\r\n  return SCRIPT_ONLY_ENTRIES;\r\n}\r\n","import { resolve } from \"path\";\r\nimport type { ExtraPageItem } from \"./types.js\";\r\n\r\n/** VideoRoll-style preset: capture / download / player / offscreen / favourites */\r\nexport function getVideoRollExtraPages(root: string, srcDir: string): ExtraPageItem[] {\r\n  const base = resolve(root, srcDir);\r\n  return [\r\n    { name: \"capture\", scriptPath: resolve(base, \"capture/index.ts\"), htmlPath: resolve(base, \"capture/capture.html\"), outHtml: \"capture/capture.html\" },\r\n    { name: \"download\", scriptPath: resolve(base, \"download/index.ts\"), htmlPath: resolve(base, \"download/download.html\"), outHtml: \"download/download.html\" },\r\n    { name: \"player\", scriptPath: resolve(base, \"player/index.ts\"), htmlPath: resolve(base, \"player/player.html\"), outHtml: \"player/player.html\" },\r\n    { name: \"offscreen\", scriptPath: resolve(base, \"offscreen/offscreen.ts\"), htmlPath: resolve(base, \"offscreen/offscreen.html\"), outHtml: \"offscreen/offscreen.html\" },\r\n    { name: \"favourites\", scriptPath: resolve(base, \"favourites/index.ts\"), htmlPath: resolve(base, \"favourites/favourites.html\"), outHtml: \"favourites/favourites.html\" },\r\n  ];\r\n}\r\n\r\nexport function resolveExtraPages(\r\n  extraPages: ExtraPageItem[] | \"video-roll\" | undefined,\r\n  root: string,\r\n  srcDirRelative: string\r\n): ExtraPageItem[] {\r\n  if (!extraPages) return [];\r\n  if (Array.isArray(extraPages)) return extraPages;\r\n  if (extraPages === \"video-roll\") return getVideoRollExtraPages(root, srcDirRelative);\r\n  return [];\r\n}\r\n","import type { ManifestConfig, EntryInfo } from \"./types.js\";\r\n\r\nfunction buildManifestForBrowser(\r\n  manifest: Record<string, unknown>,\r\n  entries: EntryInfo[],\r\n  _browser: \"chromium\" | \"firefox\"\r\n): Record<string, unknown> {\r\n  const out: Record<string, unknown> = { ...manifest };\r\n\r\n  const hasBackground = entries.some((e) => e.name === \"background\");\r\n  const hasContent = entries.some((e) => e.name === \"content\");\r\n\r\n  if (hasBackground) {\r\n    (out as Record<string, unknown>).background = {\r\n      service_worker: \"background/index.js\",\r\n    };\r\n  }\r\n\r\n  if (hasContent) {\r\n    (out as Record<string, unknown>).content_scripts = [\r\n      {\r\n        matches: [\"<all_urls>\"],\r\n        js: [\"content/index.js\"],\r\n        run_at: \"document_start\",\r\n      },\r\n    ];\r\n  }\r\n\r\n  const hasPopup = entries.some((e) => e.name === \"popup\");\r\n  if (hasPopup) {\r\n    (out as Record<string, unknown>).action = (out as Record<string, unknown>).action || {};\r\n    const action = (out as Record<string, unknown>).action as Record<string, unknown>;\r\n    action.default_popup = \"popup/index.html\";\r\n  }\r\n\r\n  const hasOptions = entries.some((e) => e.name === \"options\");\r\n  if (hasOptions) {\r\n    (out as Record<string, unknown>).options_ui = {\r\n      page: \"options/index.html\",\r\n      open_in_tab: true,\r\n    };\r\n  }\r\n\r\n  const hasSidepanel = entries.some((e) => e.name === \"sidepanel\");\r\n  if (hasSidepanel) {\r\n    (out as Record<string, unknown>).side_panel = {\r\n      default_path: \"sidepanel/index.html\",\r\n    };\r\n  }\r\n\r\n  return out;\r\n}\r\n\r\nfunction isChromiumFirefoxManifest(\r\n  m: ManifestConfig\r\n): m is { chromium?: Record<string, unknown>; firefox?: Record<string, unknown> } {\r\n  return (\r\n    typeof m === \"object\" &&\r\n    m !== null &&\r\n    (\"chromium\" in m || \"firefox\" in m)\r\n  );\r\n}\r\n\r\n/**\r\n * 根据配置与入口生成最终 manifest 对象（Chromium）\r\n */\r\nexport function resolveManifestChromium(\r\n  config: ManifestConfig,\r\n  entries: EntryInfo[]\r\n): Record<string, unknown> {\r\n  const base = isChromiumFirefoxManifest(config)\r\n    ? (config.chromium ?? config.firefox ?? {})\r\n    : (config as Record<string, unknown>);\r\n  return buildManifestForBrowser(base as Record<string, unknown>, entries, \"chromium\");\r\n}\r\n\r\n/**\r\n * 根据配置与入口生成最终 manifest 对象（Firefox）\r\n */\r\nexport function resolveManifestFirefox(\r\n  config: ManifestConfig,\r\n  entries: EntryInfo[]\r\n): Record<string, unknown> {\r\n  const base = isChromiumFirefoxManifest(config)\r\n    ? (config.firefox ?? config.chromium ?? {})\r\n    : (config as Record<string, unknown>);\r\n  return buildManifestForBrowser(base as Record<string, unknown>, entries, \"firefox\");\r\n}\r\n","import type { RsbuildConfig } from \"@rsbuild/core\";\r\n\r\nfunction isPlainObject(v: unknown): v is Record<string, unknown> {\r\n  return typeof v === \"object\" && v !== null && !Array.isArray(v);\r\n}\r\n\r\n/**\r\n * Deep-merge user rsbuildConfig into base.\r\n * plugins arrays are concatenated (base.plugins then user.plugins); other keys deep-merge with user winning.\r\n */\r\nexport function mergeRsbuildConfig(\r\n  base: RsbuildConfig,\r\n  user: RsbuildConfig\r\n): RsbuildConfig {\r\n  const result = { ...base };\r\n\r\n  for (const key of Object.keys(user) as (keyof RsbuildConfig)[]) {\r\n    const baseVal = (base as Record<string, unknown>)[key];\r\n    const userVal = (user as Record<string, unknown>)[key];\r\n    if (key === \"plugins\") {\r\n      const basePlugins = Array.isArray(baseVal) ? baseVal : [];\r\n      const userPlugins = Array.isArray(userVal) ? userVal : [];\r\n      (result as Record<string, unknown>)[key] = [...basePlugins, ...userPlugins];\r\n      continue;\r\n    }\r\n    if (isPlainObject(baseVal) && isPlainObject(userVal)) {\r\n      (result as Record<string, unknown>)[key] = mergeRsbuildConfig(\r\n        baseVal as RsbuildConfig,\r\n        userVal as RsbuildConfig\r\n      );\r\n      continue;\r\n    }\r\n    if (userVal !== undefined) {\r\n      (result as Record<string, unknown>)[key] = userVal;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n"],"mappings":"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","names":["import_path","import_fs","require","import_path"]}